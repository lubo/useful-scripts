#!/bin/bash
#
# Wraps a program in ssh-agent and adds keys into the agent. If no program is
# provided, then it spawns an interactive shell.

set -e

# shellcheck disable=SC2016
EXPECT_SCRIPT='
trap {
	global spawn_out
	set rows [stty rows]
	set cols [stty columns]
	stty rows $rows columns $cols < $spawn_out(slave,name)
} WINCH
spawn -noecho "$env(SHELL)" -i
stty -echo < $spawn_out(slave,name)
send "PS1=\"(ssh-agent) \${PS1}\"\n"
stty echo < $spawn_out(slave,name)
interact
'

main() {
	if [[ ! "${WITH_SSH_AGENT}" ]]; then
		export WITH_SSH_AGENT=1

		# User namespace isn't used to preserve ownerships.
		exec sudo \
			--preserve-env \
			-- \
			unshare \
			--mount \
			--propagation private \
			-- \
			"$0" "$@"
	fi

	if [[ ! "${SSH_AGENT_PID}" ]]; then
		GID=$(id -g "${SUDO_UID}")

		mount \
			--options "mode=0700,uid=${SUDO_UID},gid=${GID}" \
			--types tmpfs \
			tmpfs \
			~/.ssh/agent

		exec sudo \
			--preserve-env \
			--user "${USERNAME}" \
			-- \
			ssh-agent \
			-- \
			"$0" "$@"
	fi

	ssh-add || true

	if [[ "$#" -gt 0 ]]; then
		exec "$@"
	fi

	: "${SHELL:?}"

	exec expect -c "${EXPECT_SCRIPT}"
}

main "$@"
